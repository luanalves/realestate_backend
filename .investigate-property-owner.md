# Investiga√ß√£o: Property Owner como Profile Type

**Data**: 2026-02-20  
**Contexto**: An√°lise se Property Owner deve ser integrado ao sistema unificado de profiles

---

## üîç Descobertas nas Specs

### 1. **Ambiguidade Sem√¢ntica Confirmada** (DEC-011 - Feature 007)

Documentado em `specs/007-company-owner-management/research.md`:

| Termo | Entidade | Descri√ß√£o |
|-------|----------|-----------|
| **Owner** (Company Owner) | `res.users` + `group_real_estate_owner` | Propriet√°rio/s√≥cio da **IMOBILI√ÅRIA**. Gerencia a empresa. |
| **Property Owner** | `real.estate.property.owner` | Propriet√°rio do **IM√ìVEL**. Cliente da imobili√°ria. |

‚úÖ **Conclus√£o**: S√£o conceitos distintos j√° reconhecidos nas specs.

---

### 2. **Property Owner J√Å tem Acesso ao Sistema** (Feature 009)

Em `specs/009-user-onboarding-password-management/spec.md`:

#### FR1.12: Caso Especial - Perfil `owner`
> "Property Owner j√° possui cadastro existente (`owner_api.py`), mas falta o fluxo de convite com senha. O endpoint de invite cria `res.users` com grupo `group_real_estate_owner` seguindo o mesmo padr√£o, mas com `password=False` e envio de email para cria√ß√£o de senha."

#### Acceptance Criteria (US1):
- ‚úÖ "Given `profile=owner`, when Agent convida property owner, then cria `res.users` com grupo `group_real_estate_owner`"
- ‚úÖ Test case: `test_agent_invites_owner()` - Agent cria property owner e email √© enviado

#### Matriz de Autoriza√ß√£o (Tabela na p√°gina 551):
| Perfil | Pode convidar quais tipos? |
|--------|---------------------------|
| Agent  | **owner** (dono de im√≥vel), **portal** (inquilino) |

‚úÖ **Conclus√£o**: Property Owner **deve ter acesso ao sistema** via Portal/API.

---

### 3. **ADR-024: Profile Unification N√ÉO Incluiu Property Owner**

Em `docs/adr/ADR-024-profile-unification.md`:

#### 9 Tipos de Perfil Definidos:
```sql
1. owner      -- COMPANY OWNER (dono da imobili√°ria)
2. director
3. manager
4. agent
5. prospector
6. receptionist
7. financial
8. legal
9. portal     -- TENANT (inquilino/comprador)
```

#### Matriz de Autoriza√ß√£o API:
- **Agent** ‚Üí pode criar 2 tipos externos: `owner=property owner`, `portal=tenant`

‚ö†Ô∏è **Problema Identificado**: 
- ADR-024 usa `code='owner'` para **COMPANY OWNER**
- Feature 009 usa `profile='owner'` para **PROPERTY OWNER**
- **CONFLITO SEM√ÇNTICO**: mesmo c√≥digo para entidades diferentes!

---

### 4. **Implementa√ß√£o Atual Fragmentada**

#### Controllers existentes:

**`owner_api.py`** (Feature 007 - Company Owner):
```python
POST /api/v1/owners
{
  "name": "Jo√£o",
  "email": "joao@example.com", 
  "password": "12345678",
  "cpf": "12345678901"
}
‚Üí Cria res.users com group_real_estate_owner
‚Üí Company Owner (dono da imobili√°ria)
```

**`property_owner.py`** (Model separado):
```python
class PropertyOwner(models.Model):
    _name = 'real.estate.property.owner'
    _description = 'Property Owner'
    
    name = fields.Char(required=True)
    partner_id = fields.Many2one('res.partner')  # ‚Üê Portal access
    cpf = fields.Char()
    email = fields.Char()
    property_ids = fields.One2many('real.estate.property', 'owner_id')
```

‚ö†Ô∏è **Inconsist√™ncia**: Property Owner tem model dedicado, mas **n√£o tem API de cadastro**.

---

### 5. **Database: 3 Property Owners Cadastrados**

```sql
SELECT COUNT(*) FROM real_estate_property_owner;
-- Result: 3
```

‚úÖ **Confirmado**: Property Owners est√£o sendo usados no sistema.

---

## üéØ An√°lise e Recomenda√ß√£o

### Problema Detectado

1. **Profile Type `code='owner'`** foi definido para **Company Owner** (ADR-024)
2. **Feature 009** espera convidar **Property Owner** usando `profile='owner'`
3. **Model `real.estate.property.owner`** existe mas est√° **FORA** do sistema unificado de profiles
4. **Nenhuma API** existe para criar Property Owners (`owner_api.py` cria Company Owners)

### Impacto

‚ö†Ô∏è **Feature 009 n√£o pode ser implementada completamente** porque:
- Agent precisa convidar Property Owner (spec diz: `profile='owner'`)
- Mas `profile_type_id=1 (code='owner')` aponta para Company Owner
- Property Owner n√£o tem `profile_type_id` correspondente

### Solu√ß√£o Proposta

**Op√ß√£o 1: Adicionar 10¬∫ Profile Type para Property Owner** ‚úÖ RECOMENDADA

```sql
INSERT INTO thedevkitchen_profile_type (id, name, code) VALUES
(10, '{"en_US": "Propriet√°rio de Im√≥vel"}', 'property_owner');
```

**Benef√≠cios**:
- ‚úÖ Resolve conflito sem√¢ntico (owner ‚â† property_owner)
- ‚úÖ Permite Feature 009 funcionar (Agent convida property_owner)
- ‚úÖ Unifica Property Owner no sistema de profiles
- ‚úÖ Consistente com arquitetura ADR-024

**Mudan√ßas necess√°rias**:
1. Adicionar `profile_type_id=10` (property_owner) em `profile_type_data.xml`
2. Atualizar ADR-024 para incluir o 10¬∫ tipo
3. Migrar registros de `real.estate.property.owner` ‚Üí `thedevkitchen.estate.profile`
4. Atualizar Feature 009: Agent convida `profile_type='property_owner'` (n√£o 'owner')
5. Atualizar FK em `real.estate.property.owner_id` ‚Üí apontar para `profile_id`

---

**Op√ß√£o 2: Renomear Owner ‚Üí Company Owner** (Breaking Change)

```sql
UPDATE thedevkitchen_profile_type 
SET code = 'company_owner', name = '{"en_US": "Propriet√°rio da Empresa"}'
WHERE id = 1;

INSERT INTO thedevkitchen_profile_type (id, name, code) VALUES
(10, '{"en_US": "Propriet√°rio de Im√≥vel"}', 'property_owner');
```

‚ö†Ô∏è **Breaking Change**: Todos os endpoints que usam `profile='owner'` quebram.

---

## üìã Checklist de Implementa√ß√£o

Se optar por adicionar Property Owner como 10¬∫ perfil:

- [ ] Criar migration script: adicionar `profile_type_id=10`
- [ ] Atualizar `profile_type_data.xml`
- [ ] Atualizar ADR-024 (de 9 para 10 tipos)
- [ ] Migrar `real_estate_property_owner` para `thedevkitchen_estate_profile`
- [ ] Criar API `POST /api/v1/profiles` com `profile_type='property_owner'`
- [ ] Atualizar Feature 009: Agent invita `property_owner` (n√£o `owner`)
- [ ] Atualizar matriz de autoriza√ß√£o (Agent ‚Üí pode criar property_owner + portal)
- [ ] Atualizar testes de integra√ß√£o
- [ ] Atualizar OpenAPI specs

---

## üìö Refer√™ncias

- `specs/007-company-owner-management/research.md` - DEC-011
- `specs/009-user-onboarding-password-management/spec.md` - FR1.12, US1, US6
- `docs/adr/ADR-024-profile-unification.md` - Profile structure
- `18.0/extra-addons/quicksol_estate/models/property_owner.py` - Model atual
- `18.0/extra-addons/quicksol_estate/controllers/owner_api.py` - Company Owner API

---

**Conclus√£o**: Property Owner **DEVE** ser integrado ao sistema unificado de profiles como 10¬∫ tipo para permitir acesso via Portal/API conforme especificado na Feature 009.

---

## ‚úÖ SOLU√á√ÉO IMPLEMENTADA (2026-02-20)

### Mudan√ßas Aplicadas

**1. Adicionado 10¬∫ Profile Type: `property_owner`**
- Arquivo: `data/profile_type_data.xml`
- Code: `property_owner`
- Name: "Propriet√°rio de Im√≥vel"
- Level: `external`
- Group: `group_real_estate_property_owner`

**2. Criado Security Group**
- Arquivo: `security/groups.xml`
- Group: `group_real_estate_property_owner`
- Inherits: `base.group_portal`
- Descri√ß√£o: Propriet√°rio de im√≥vel (cliente) com acesso via portal

**3. Migration Scripts**
- Diret√≥rio: `migrations/18.0.3.0.0/`
- SQL: `add_property_owner_profile_type.sql`
- Documenta√ß√£o: `migrations/18.0.3.0.0/README.md`

**4. ADR-024 Atualizada**
- De: 9 profile types
- Para: 10 profile types
- Adicionada se√ß√£o 5: "Property Owner como 10¬∫ Profile Type"
- Matriz de autoriza√ß√£o atualizada

**5. Feature 009 Atualizada**
- `owner` ‚Üí `property_owner` (quando se refere a property owner)
- Enum atualizado com 10 valores
- Acceptance criteria atualizados
- Test names atualizados

### Nova Matriz de Autoriza√ß√£o

| Profile | Pode Criar | Quantidade | Detalhes |
|---------|-----------|------------|----------|
| **Owner** (Company Owner) | **Todos os 10 tipos** | 10/10 | Controle total da empresa |
| **Manager** | Operacionais | 5/10 | agent, prospector, receptionist, financial, legal |
| **Agent** | Externos | 2/10 | **property_owner**, portal |

### Clareza Sem√¢ntica Estabelecida

```
owner          ‚Üí Company Owner (dono da imobili√°ria, admin)
property_owner ‚Üí Property Owner (dono do im√≥vel, cliente externo)
portal         ‚Üí Tenant/Buyer (inquilino/comprador, cliente externo)
```

### Profile Types Completos (10)

**Admin Level (3)**:
1. owner - Company Owner
2. director - Diretor
3. manager - Gerente

**Operational Level (5)**:
4. agent - Corretor
5. prospector - Captador
6. receptionist - Atendente
7. financial - Financeiro  
8. legal - Jur√≠dico

**External Level (2)**:
9. portal - Inquilino/Comprador
10. property_owner - Propriet√°rio de Im√≥vel ‚ú® **NOVO**

### Pr√≥ximos Passos (Phase 2)

- [ ] Executar migration script no banco de desenvolvimento
- [ ] Testar cria√ß√£o de profile property_owner via API
- [ ] Migrar dados de `real_estate_property_owner` para `thedevkitchen_estate_profile`
- [ ] Atualizar FK em `real.estate.property`
- [ ] Criar endpoint dedicado ou usar `/api/v1/profiles?profile_type=property_owner`
- [ ] Atualizar testes de integra√ß√£o
- [ ] Verificar Feature 009 integration (Agent invites property_owner)

---

**Status**: ‚úÖ RESOLVIDO - Ambiguidade sem√¢ntica eliminada, 10¬∫ profile type adicionado ao sistema.

