# Implementation Plan: Real Estate Lead Management System

**Branch**: `006-lead-management` | **Date**: 2026-01-29 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/006-lead-management/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

Implement a custom real estate lead management system (`real.estate.lead`) for tracking potential clients through the sales pipeline. Agents create leads with contact info and property preferences (budget, type, location, bedrooms), manage pipeline states (New â†’ Contacted â†’ Qualified â†’ Won/Lost), and convert qualified leads to property sales. Managers oversee all company leads while respecting multi-tenancy isolation. System integrates with existing RBAC profiles, enforces per-agent duplicate prevention, uses soft delete for data retention, and tracks all activities via Odoo's mail.thread. No dependency on Odoo CRM module - custom implementation following existing architectural patterns.

## Technical Context

**Language/Version**: Python 3.11  
**Primary Dependencies**: Odoo 18.0 (ORM, mail.thread, mail.activity.mixin), PostgreSQL 16+, Redis 7  
**Storage**: PostgreSQL (`realestate` database) for persistent data, Redis (DB 1) for sessions/cache  
**Testing**: Python unittest (unit tests with mocks), Cypress (E2E UI), curl/shell scripts (E2E API) - per ADR-003  
**Target Platform**: Docker containers (Linux) - Odoo 18.0 backend serving REST APIs  
**Project Type**: Web - Headless SSR frontend (Next.js) consuming REST APIs + Odoo Web for managers  
**Performance Goals**: Agent creates lead <2 minutes, Manager dashboard loads <3 seconds for 5000 leads  
**Constraints**: Zero cross-company data leakage (multi-tenancy), 80% test coverage mandatory, soft delete only  
**Scale/Scope**: ~10 new endpoints (CRUD leads), 1 new model (real.estate.lead), 3 views (list/form/kanban), 5 record rules, expected ~1000 leads per company

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### âœ… Principle I: Security First
- All endpoints will use `@require_jwt`, `@require_session`, `@require_company` decorators (per ADR-011)
- No public endpoints in this feature (all lead operations require authentication)
- Multi-tenancy enforced via `company_ids` filtering in all record rules
- Session-based authentication with Redis storage already configured

### âœ… Principle II: Test Coverage Mandatory
- Committed to 80% minimum coverage per ADR-003
- Unit tests: Model validations, duplicate detection logic, state transitions
- E2E API tests: All CRUD endpoints with auth/validation/permissions scenarios
- E2E Cypress: Agent creates lead, manager views dashboard, lead conversion flow
- Test plan covers all acceptance scenarios from spec
- **Test creation will use specialized prompts**:
  - `.github/prompts/test-strategy.prompt.md` for test type analysis
  - `.github/prompts/test-executor.prompt.md` for test code generation
  - `.github/agents/speckit.tests.agent.md` for acceptance scenario-based test generation
- Ensures consistency, ADR-003 compliance, and proper `.env` credential usage

### âœ… Principle III: API-First Design
- All features expose REST APIs following existing patterns (`success_response()`, `error_response()`)
- OpenAPI documentation will be generated for all endpoints
- JSON request/response formats consistent with existing property/agent APIs
- Master data endpoints for lead states, property types (already exist)

### âœ… Principle IV: Multi-Tenancy by Design
- All queries filtered by `company_ids` via `@require_company` decorator
- Record rules enforce company isolation: `[('company_ids', 'in', user.estate_company_ids.ids)]`
- Agent-level isolation: `[('agent_id', '=', user.agent_id.id)]` for agent access
- Manager-level access: company filter only (can see all agents in company)
- Validation on create/update ensures company ownership
- Integration tests will verify zero cross-company leakage (SC-003)

### âœ… Principle V: ADR Governance
- Following ADR-001 (module structure): Add models/controllers/tests to `quicksol_estate` module
- Following ADR-004 (naming): `real.estate.lead` model, `lead_api.py` controller
- Following ADR-003 (testing): Unit tests with mocks, E2E with real DB
- Following ADR-011 (security): Triple decorator pattern on all endpoints
- Following ADR-007 (HATEOAS): Will include hypermedia links in responses (Phase 3 pattern)
- No new ADRs required - using existing patterns

### âœ… Principle VI: Headless Architecture
- Lead management APIs consumed by Next.js SSR frontend (agency interface)
- Managers can use Odoo Web views for operational oversight
- No browser-side credential exposure (SSR handles auth tokens server-side)
- API endpoints follow existing `/api/v1/leads` pattern

**GATE STATUS**: âœ… **PASS** - No constitution violations. Feature aligns with all core principles.

---

## Post-Phase 1 Constitution Re-Check

**Date**: 2026-01-29  
**Status**: âœ… **CONFIRMED PASS**

All design decisions from Phase 1 (data model + contracts) validated against constitution:

### âœ… Security First
- **Confirmed**: All 8 endpoints use triple decorator pattern (`@require_jwt`, `@require_session`, `@require_company`)
- **Confirmed**: No public endpoints in this feature
- **Confirmed**: Record rules enforce both multi-tenancy AND agent isolation
- **Confirmed**: Soft delete prevents data loss while maintaining security boundaries

### âœ… Test Coverage Mandatory
- **Confirmed**: Test strategy documented in quickstart.md
- **Confirmed**: Unit tests planned for all validations (duplicate check, budget, state transitions)
- **Confirmed**: E2E tests planned for all 8 API endpoints + isolation scenarios
- **Confirmed**: Cypress tests planned for UI flows (agent CRUD, manager dashboard, conversion)
- **Target**: 80% coverage achievable with planned tests
- **Confirmed**: Test creation will follow constitution requirement to use specialized prompts:
  - Test Strategy Agent (`.github/prompts/test-strategy.prompt.md`) for analysis
  - Test Executor Agent (`.github/prompts/test-executor.prompt.md`) for code generation
  - SpecKit Tests Agent (`.github/agents/speckit.tests.agent.md`) for scenario-based tests

### âœ… API-First Design
- **Confirmed**: Complete OpenAPI 3.0 schema generated (contracts/openapi.yaml)
- **Confirmed**: All endpoints follow existing patterns (`success_response()`, `error_response()`)
- **Confirmed**: Pagination documented with metadata (page, limit, total, pages)
- **Future**: HATEOAS links reserved for Phase 3 (per ADR-007)

### âœ… Multi-Tenancy by Design
- **Confirmed**: All record rules include `('company_ids', 'in', user.estate_company_ids.ids)`
- **Confirmed**: Agent rule adds `('agent_id.user_id', '=', user.id)` for additional isolation
- **Confirmed**: Manager rule uses company filter only (sees all agents in company)
- **Confirmed**: Validation prevents agent assignment to wrong companies (FR-023)

### âœ… ADR Governance
- **Confirmed**: Module structure follows ADR-001 (extends quicksol_estate, not new module)
- **Confirmed**: Naming follows ADR-004 (`real.estate.lead`, `lead_api.py`)
- **Confirmed**: Security follows ADR-011 (triple decorator + record rules)
- **Confirmed**: Testing follows ADR-003 (unit with mocks, E2E with real DB)
- **No new ADRs required**: All patterns reuse existing decisions

### âœ… Headless Architecture
- **Confirmed**: APIs designed for Next.js SSR consumption (JSON responses)
- **Confirmed**: Odoo Web views available for manager oversight
- **Confirmed**: No frontend code in this repository (separation of concerns)
- **Confirmed**: SSR handles auth tokens server-side (enhanced security)

**Overall Assessment**: Design remains fully compliant with constitution. No violations introduced during Phase 1. Proceed to Phase 2 (tasks breakdown).

## Project Structure

### Documentation (this feature)

```text
specs/006-lead-management/
â”œâ”€â”€ plan.md              # This file (/speckit.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output (/speckit.plan command)
â”œâ”€â”€ data-model.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ quickstart.md        # Phase 1 output (/speckit.plan command)
â”œâ”€â”€ contracts/           # Phase 1 output (/speckit.plan command)
â”‚   â””â”€â”€ openapi.yaml     # OpenAPI 3.0 spec (8 endpoints)
â””â”€â”€ tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)

docs/openapi/
â””â”€â”€ lead-management-api-spec.yaml    # Central OpenAPI spec (copied from contracts/)

docs/postman/
â”œâ”€â”€ lead-management-collection.json  # Postman collection (8 endpoints + test scenarios)
â””â”€â”€ README.md                        # Updated with lead management collection info
```

### Source Code (repository root)

```text
18.0/extra-addons/quicksol_estate/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ real_estate_lead.py              # New: Lead model (mail.thread, mail.activity.mixin)
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ lead_api.py                      # New: REST API endpoints for lead CRUD
â”œâ”€â”€ views/
â”‚   â””â”€â”€ real_estate_lead_views.xml       # New: List, form, kanban, calendar views
â”œâ”€â”€ security/
â”‚   â”œâ”€â”€ ir.model.access.csv              # Update: Add lead model access rules
â”‚   â””â”€â”€ real_estate_lead_security.xml    # New: Record rules (agent/manager/multi-tenant)
â”œâ”€â”€ data/
â”‚   â””â”€â”€ real_estate_lead_data.xml        # Optional: Demo data for testing
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â””â”€â”€ test_lead_validations_unit.py       # New: Duplicate detection, state transitions
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ test_lead_api.py              # New: CRUD endpoints + auth + permissions

cypress/e2e/
â”œâ”€â”€ lead-agent-crud.cy.js                # New: Agent creates/updates/converts lead
â”œâ”€â”€ lead-manager-dashboard.cy.js         # New: Manager views all company leads
â””â”€â”€ lead-isolation.cy.js                 # New: Multi-tenancy + agent isolation

integration_tests/
â”œâ”€â”€ test_us_lead_agent_crud.sh           # New: Agent CRUD via curl
â”œâ”€â”€ test_us_lead_manager_view.sh         # New: Manager access via curl
â””â”€â”€ test_us_lead_multitenancy.sh         # New: Cross-company isolation via curl

specs/006-lead-management/
â”œâ”€â”€ plan.md                              # This file
â”œâ”€â”€ research.md                          # Phase 0 output (next)
â”œâ”€â”€ data-model.md                        # Phase 1 output
â”œâ”€â”€ quickstart.md                        # Phase 1 output
â”œâ”€â”€ contracts/                           # Phase 1 output (OpenAPI schemas)
â””â”€â”€ tasks.md                             # Phase 2 output (created by /speckit.tasks)
```

**Structure Decision**: Extending existing `quicksol_estate` module (ADR-001). This feature adds one model (`real.estate.lead`) to an existing domain (estate management), not creating a separate module. Follows established pattern: models for business logic, controllers for API, views for UI, security for access control, tests for both unit (mocked) and E2E (real DB). No frontend code in this repository (headless SSR frontend lives separately).

## Complexity Tracking

**Not Applicable**: No constitution violations. Feature follows all established patterns and principles.

---

## Planning Deliverables Summary

The `/speckit.plan` command has completed successfully. All planning artifacts are ready for implementation:

### âœ… Phase 0: Research (research.md)
- 6 technical topics researched with architectural decisions
- Mail.thread integration pattern for activity tracking
- Duplicate detection strategy (per-agent via @api.constrains)
- Soft delete pattern using Odoo `active` field
- Record rules for agent/manager/multi-tenant isolation
- Atomic transaction management patterns
- Performance optimization strategy (indexes + pagination)

### âœ… Phase 1: Design (data-model.md, contracts/, quickstart.md)
- **Data Model**: Complete `real.estate.lead` specification
  - 25 fields (contact info, preferences, pipeline state, tracking)
  - 4 validation rules (duplicate, budget, company, lost_reason)
  - 3 custom methods (unlink override, reopen, auto-assignment)
  - Security model with 3 record rules
  - Database schema with indexes on state/agent_id/create_date

- **API Contracts** (contracts/openapi.yaml):
  - OpenAPI 3.0 specification with 8 endpoints
  - Complete request/response schemas
  - Security schemes (Bearer, Session, Company Header)
  - Pagination metadata pattern
  - Error response structures
  - **Also available at**: docs/openapi/lead-management-api-spec.yaml (for Swagger UI)

- **Developer Guide** (quickstart.md):
  - Architecture overview with data flow diagrams
  - Security decorator patterns and examples
  - Record rule automatic filtering explanation
  - API endpoint examples with curl commands
  - Test creation workflow with agent prompts
  - Common troubleshooting scenarios
  - Performance optimization guidelines

- **Postman Collection** (docs/postman/lead-management-collection.json):
  - 15 requests organized in 5 folders:
    - Authentication (OAuth + Login with session)
    - Leads - CRUD (list/create/get/update/delete)
    - Lead Actions (convert to sale, reopen lost lead)
    - Lead Analytics (statistics endpoint)
    - Test Scenarios (duplicate detection, manager access, multi-tenancy, state transitions, lost lead marking)
  - Environment variables: jwt_token, session_id, company_id, lead_id, property_id
  - Pre-request scripts for auth token injection
  - Test assertions for response validation
  - **Documentation**: docs/postman/README.md (updated to v1.3.0)

### âœ… Agent Context Update
- Updated `.github/agents/copilot-instructions.md` with:
  - Python 3.11 (for async enhancements)
  - Odoo 18.0 ORM and mail mixins
  - PostgreSQL 16+ (for advanced indexing)
  - Redis 7 (for session management)

### âœ… Constitution Compliance
- All 6 core principles validated (Security, Testing, API-First, Multi-Tenancy, ADR Governance, Headless)
- Pre-Phase 0 check: âœ… PASS
- Post-Phase 1 check: âœ… CONFIRMED PASS
- No violations or deviations

### ðŸ“‹ Next Steps (Not Part of /speckit.plan)

To continue implementation:

1. **Break down into tasks**: Run `/speckit.tasks` to generate atomic task breakdown (tasks.md)
2. **Write tests first**: Use test agent prompts to generate comprehensive test suite
3. **Implement model**: Create `real_estate_lead.py` with fields/validations/methods
4. **Implement controller**: Create `lead_api.py` with 8 REST endpoints
5. **Implement security**: Create record rules and update access control
6. **Implement views**: Create Odoo Web views for manager oversight
7. **Run test suite**: Execute unit tests + E2E tests (API + Cypress)
8. **Review coverage**: Ensure 80% minimum (constitution requirement)

### ðŸ“š Reference Documentation

- **Feature Specification**: [spec.md](spec.md) (includes clarifications)
- **Technical Research**: [research.md](research.md) (architectural decisions)
- **Data Model**: [data-model.md](data-model.md) (complete model specification)
- **Developer Guide**: [quickstart.md](quickstart.md) (examples and patterns)
- **API Contracts**: [contracts/openapi.yaml](contracts/openapi.yaml) (OpenAPI 3.0 spec)
- **OpenAPI (Central)**: docs/openapi/lead-management-api-spec.yaml (for Swagger UI at /api/docs)
- **Postman Collection**: docs/postman/lead-management-collection.json (15 requests with test scenarios)
- **Constitution**: .specify/memory/constitution.md (v1.1.0 with test agent requirements)

---

**Status**: Planning phase complete. Ready for `/speckit.tasks` or direct implementation.
