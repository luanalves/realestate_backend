openapi: 3.0.3
info:
  title: Real Estate Lead Management API
  description: |
    REST API for managing real estate leads through the sales pipeline.
    
    **Authentication**: All endpoints require:
    - `Authorization: Bearer <JWT>` header (OAuth 2.0 token)
    - `session_id` cookie (HTTP session)
    - `X-Company-ID` header (multi-tenancy context)
    
    **Base URL**: `https://api.example.com/api/v1`
  version: 1.0.0
  contact:
    name: API Support
    email: api@example.com

servers:
  - url: http://localhost:8069/api/v1
    description: Development server
  - url: https://api.production.com/api/v1
    description: Production server

tags:
  - name: Leads
    description: Lead CRUD operations
  - name: Lead Actions
    description: State transitions and special actions

security:
  - BearerAuth: []
  - SessionCookie: []
  - CompanyHeader: []

paths:
  /leads:
    get:
      summary: List leads
      description: |
        Returns paginated list of leads filtered by user's access level:
        - **Agents**: Only their own leads
        - **Managers**: All company leads
        
        Record rules automatically enforce multi-tenancy and agent isolation.
      operationId: listLeads
      tags:
        - Leads
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/StateFilter'
        - $ref: '#/components/parameters/AgentFilter'
        - $ref: '#/components/parameters/SearchQuery'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadListResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'
    
    post:
      summary: Create lead
      description: |
        Creates a new lead with auto-assigned agent_id (current user's agent record).
        
        **Validation**:
        - Duplicate prevention: Same agent cannot create lead with same phone/email (for active leads)
        - Company validation: Agent must belong to specified companies
        - Budget validation: budget_min <= budget_max
      operationId: createLead
      tags:
        - Leads
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadCreateRequest'
      responses:
        '201':
          description: Lead created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'

  /leads/{lead_id}:
    get:
      summary: Get lead details
      description: Returns full lead details including related records and activity history
      operationId: getLead
      tags:
        - Leads
      parameters:
        - $ref: '#/components/parameters/LeadIdParam'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadDetailResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    
    put:
      summary: Update lead
      description: |
        Updates lead fields. Agents can only update their own leads, managers can update all company leads.
        
        **Restrictions**:
        - Agents cannot change agent_id (FR-022)
        - State transitions log changes in activity history
      operationId: updateLead
      tags:
        - Leads
      parameters:
        - $ref: '#/components/parameters/LeadIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadUpdateRequest'
      responses:
        '200':
          description: Lead updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'
    
    delete:
      summary: Archive lead (soft delete)
      description: |
        Archives lead by setting active=False. Actual deletion is prevented (FR-018b).
        Archived leads are hidden from normal views but remain in database for reporting.
      operationId: archiveLead
      tags:
        - Leads
      parameters:
        - $ref: '#/components/parameters/LeadIdParam'
      responses:
        '204':
          description: Lead archived successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'

  /leads/{lead_id}/convert:
    post:
      summary: Convert lead to sale
      description: |
        Converts qualified lead to property sale. Creates sale record and updates lead state to 'won'.
        
        **Transaction**: Atomic operation - either both lead update and sale creation succeed, or both fail (FR-014).
        
        **Requirements**:
        - Lead must be in 'qualified' state (recommended)
        - Property must exist and agent must have access
        - Contact info is copied to sale record
      operationId: convertLead
      tags:
        - Lead Actions
      parameters:
        - $ref: '#/components/parameters/LeadIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LeadConvertRequest'
      responses:
        '200':
          description: Lead converted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadConvertResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'

  /leads/{lead_id}/reopen:
    post:
      summary: Reopen lost lead
      description: |
        Reopens a lost lead by changing state from 'lost' to 'contacted'.
        Both agents (own leads) and managers (company leads) can reopen (FR-18a).
        Logs reactivation in activity history with reason.
      operationId: reopenLead
      tags:
        - Lead Actions
      parameters:
        - $ref: '#/components/parameters/LeadIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Reason for reopening lead
                  example: "Client re-engaged after 2 months"
              required:
                - reason
      responses:
        '200':
          description: Lead reopened successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '404':
          $ref: '#/components/responses/NotFoundError'
        '500':
          $ref: '#/components/responses/ServerError'

  /leads/statistics:
    get:
      summary: Get lead statistics
      description: |
        Returns aggregated statistics for dashboard:
        - Lead count by state
        - Conversion rates
        - Average days in each state
        
        Filtered by user's access level (agent sees own stats, manager sees company stats).
      operationId: getLeadStatistics
      tags:
        - Leads
      parameters:
        - name: agent_id
          in: query
          required: false
          schema:
            type: integer
          description: Filter stats by specific agent (managers only)
        - name: date_from
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Start date for date range filter
        - name: date_to
          in: query
          required: false
          schema:
            type: string
            format: date
          description: End date for date range filter
      responses:
        '200':
          description: Statistics calculated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LeadStatisticsResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '500':
          $ref: '#/components/responses/ServerError'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: OAuth 2.0 JWT token from authentication endpoint
    SessionCookie:
      type: apiKey
      in: cookie
      name: session_id
      description: HTTP session cookie for user context
    CompanyHeader:
      type: apiKey
      in: header
      name: X-Company-ID
      description: Company ID for multi-tenancy context

  parameters:
    LeadIdParam:
      name: lead_id
      in: path
      required: true
      schema:
        type: integer
      description: Lead ID
    
    PageParam:
      name: page
      in: query
      required: false
      schema:
        type: integer
        default: 1
        minimum: 1
      description: Page number for pagination
    
    LimitParam:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        default: 50
        minimum: 1
        maximum: 100
      description: Items per page
    
    StateFilter:
      name: state
      in: query
      required: false
      schema:
        type: string
        enum: [new, contacted, qualified, won, lost]
      description: Filter by lead state
    
    AgentFilter:
      name: agent_id
      in: query
      required: false
      schema:
        type: integer
      description: Filter by agent (managers only)
    
    SearchQuery:
      name: q
      in: query
      required: false
      schema:
        type: string
      description: Search query (searches name, phone, email)

  schemas:
    LeadCreateRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 100
          description: Lead name/title
          example: "João Silva - Apartamento Centro"
        phone:
          type: string
          maxLength: 20
          description: Primary phone number
          example: "+55 11 98765-4321"
        email:
          type: string
          format: email
          maxLength: 120
          description: Email address
          example: "joao.silva@example.com"
        partner_id:
          type: integer
          nullable: true
          description: Existing contact ID (res.partner)
        budget_min:
          type: number
          format: float
          description: Minimum budget in BRL
          example: 200000.00
        budget_max:
          type: number
          format: float
          description: Maximum budget in BRL
          example: 350000.00
        property_type_interest:
          type: integer
          nullable: true
          description: Desired property type ID
        location_preference:
          type: string
          maxLength: 200
          description: Preferred locations
          example: "Centro, Jardins, Paulista"
        bedrooms_needed:
          type: integer
          nullable: true
          description: Desired number of bedrooms
          example: 2
        min_area:
          type: number
          format: float
          nullable: true
          description: Minimum area in m²
          example: 50.0
        max_area:
          type: number
          format: float
          nullable: true
          description: Maximum area in m²
          example: 80.0
        property_interest:
          type: integer
          nullable: true
          description: Specific property of interest ID
        first_contact_date:
          type: string
          format: date
          nullable: true
          description: Date of first contact
        expected_closing_date:
          type: string
          format: date
          nullable: true
          description: Expected deal closing date
        company_ids:
          type: array
          items:
            type: integer
          description: Company IDs (auto-assigned if omitted)

    LeadUpdateRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 100
        phone:
          type: string
          maxLength: 20
        email:
          type: string
          format: email
          maxLength: 120
        partner_id:
          type: integer
          nullable: true
        state:
          type: string
          enum: [new, contacted, qualified, won, lost]
        budget_min:
          type: number
          format: float
        budget_max:
          type: number
          format: float
        property_type_interest:
          type: integer
          nullable: true
        location_preference:
          type: string
          maxLength: 200
        bedrooms_needed:
          type: integer
          nullable: true
        min_area:
          type: number
          format: float
          nullable: true
        max_area:
          type: number
          format: float
          nullable: true
        property_interest:
          type: integer
          nullable: true
        first_contact_date:
          type: string
          format: date
          nullable: true
        expected_closing_date:
          type: string
          format: date
          nullable: true
        lost_reason:
          type: string
          nullable: true
          description: Required when state changes to 'lost'

    LeadResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          $ref: '#/components/schemas/Lead'

    LeadDetailResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          allOf:
            - $ref: '#/components/schemas/Lead'
            - type: object
              properties:
                activities:
                  type: array
                  items:
                    $ref: '#/components/schemas/Activity'
                messages:
                  type: array
                  items:
                    $ref: '#/components/schemas/Message'

    LeadListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            leads:
              type: array
              items:
                $ref: '#/components/schemas/Lead'
            pagination:
              $ref: '#/components/schemas/Pagination'

    LeadConvertRequest:
      type: object
      required:
        - property_id
      properties:
        property_id:
          type: integer
          description: Property ID to link to sale
          example: 42

    LeadConvertResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            lead_id:
              type: integer
              example: 123
            sale_id:
              type: integer
              example: 456
            message:
              type: string
              example: "Lead successfully converted to sale"

    LeadStatisticsResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            by_state:
              type: object
              properties:
                new:
                  type: integer
                  example: 15
                contacted:
                  type: integer
                  example: 23
                qualified:
                  type: integer
                  example: 8
                won:
                  type: integer
                  example: 12
                lost:
                  type: integer
                  example: 7
            conversion_rate:
              type: number
              format: float
              description: Percentage of qualified leads converted to won
              example: 60.0
            avg_days_to_convert:
              type: number
              format: float
              description: Average days from creation to won state
              example: 14.5
            total_leads:
              type: integer
              example: 65

    Lead:
      type: object
      properties:
        id:
          type: integer
          example: 123
        name:
          type: string
          example: "João Silva - Apartamento Centro"
        active:
          type: boolean
          example: true
        state:
          type: string
          enum: [new, contacted, qualified, won, lost]
          example: "qualified"
        create_date:
          type: string
          format: date-time
          example: "2026-01-29T10:30:00Z"
        phone:
          type: string
          nullable: true
          example: "+55 11 98765-4321"
        email:
          type: string
          nullable: true
          example: "joao.silva@example.com"
        partner_id:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        agent_id:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        company_ids:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string
        budget_min:
          type: number
          format: float
          nullable: true
          example: 200000.00
        budget_max:
          type: number
          format: float
          nullable: true
          example: 350000.00
        property_type_interest:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        location_preference:
          type: string
          nullable: true
          example: "Centro, Jardins"
        bedrooms_needed:
          type: integer
          nullable: true
          example: 2
        min_area:
          type: number
          format: float
          nullable: true
          example: 50.0
        max_area:
          type: number
          format: float
          nullable: true
          example: 80.0
        property_interest:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        first_contact_date:
          type: string
          format: date
          nullable: true
          example: "2026-01-29"
        expected_closing_date:
          type: string
          format: date
          nullable: true
          example: "2026-02-15"
        lost_date:
          type: string
          format: date
          nullable: true
        lost_reason:
          type: string
          nullable: true
        converted_property_id:
          type: object
          nullable: true
          properties:
            id:
              type: integer
            name:
              type: string
        converted_sale_id:
          type: integer
          nullable: true
        days_in_state:
          type: integer
          description: Computed field - days in current state
          example: 5

    Activity:
      type: object
      properties:
        id:
          type: integer
        activity_type:
          type: string
          enum: [call, email, meeting, todo]
        summary:
          type: string
        date_deadline:
          type: string
          format: date
        user_id:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        state:
          type: string
          enum: [planned, overdue, today, done]

    Message:
      type: object
      properties:
        id:
          type: integer
        body:
          type: string
        date:
          type: string
          format: date-time
        author_id:
          type: object
          properties:
            id:
              type: integer
            name:
              type: string
        subtype:
          type: string

    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 50
        total:
          type: integer
          example: 234
        pages:
          type: integer
          example: 5

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            message:
              type: string
              example: "Validation error"
            code:
              type: string
              example: "VALIDATION_ERROR"
            details:
              type: object
              nullable: true

  responses:
    UnauthorizedError:
      description: Authentication failed (missing or invalid JWT/session)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              message: "Authentication required"
              code: "UNAUTHORIZED"
    
    ForbiddenError:
      description: User lacks permission to access resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              message: "Access denied"
              code: "FORBIDDEN"
    
    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              message: "Lead not found"
              code: "NOT_FOUND"
    
    ValidationError:
      description: Request validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              message: "Validation failed"
              code: "VALIDATION_ERROR"
              details:
                phone: "You already have an active lead with this phone number"
    
    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            error:
              message: "Internal server error"
              code: "SERVER_ERROR"
